<lift:children>
	<head_merge>
	<link rel="stylesheet" href="/css/jquery.fileupload-ui.min.css" type="text/css" />
	<link rel="stylesheet" href="/css/bootstrap-modal.min.css" type="text/css" />
	<link rel="stylesheet" href="/css/jquery.jcrop.min.css" type="text/css" />
	<style>
#original-img-box {
	width: 400px;
	height: 300px;
	border: 1px solid #ddd;
	background-color: #fafafa;
	display: block;
}

#preview-img-box {
	border: 1px solid #ddd;
	background-color: #fafafa;
	width: 320px;
	height: 200px;
	overflow: hidden;
	display: block;
}
</style>
	</head_merge>
	<div id="uploadDialog" class="modal hide fade" tabindex="-1" data-backdrop="static" data-keyboard="false" data-width="765">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3 id="loginModalLabel">商标图片上传</h3>
		</div>
		<div class="modal-body">
			<div class="row-fluid">
				<div class="pull-left" style="margin-right: 10px;">
					<form id="file-upload" action="/uploading" method="POST" enctype="multipart/form-data">
						<span class="btn btn-success fileinput-button"> <i class="icon-plus icon-white"></i> <span>商标图片上传...</span> <input id="fileupload" type="file" name="files[]"/>
						</span>
					</form>
				</div>
				<div id="progress" class="progress progress-striped active" style="margin-top: 5px; margin-bottom: 0">
					<div id="progress-bar" class="bar" style="width: 40%;"></div>
				</div>
			</div>
			<div class="row-fluid">
				<div style="margin-top: 10px">
					<div id="original-img-box" class="jcrop pull-left">
						<img id="original-img" />
					</div>
					<div id="preview-img-box" class="jcrop pull-right">
						<img id="preview-img" />
					</div>
				</div>
			</div>
		</div>
		<div class="modal-footer">
			<form data-lift="form.ajax">
				<div data-lift="user.BrandOps.uploadBrandPic">
					<input type="hidden" id="picName" name="picName" /> <input type="hidden" id="x" name="x" /> <input type="hidden" id="y" name="y" /> <input type="hidden" id="w" name="w" /> <input type="hidden" id="h" name="h" />
					<button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
					<button type="submit" id="submit-avatar" class="btn btn-primary">保存商标图</button>
				</div>
			</form>

		</div>
	</div>

	<lift:tail>
		<script type="text/javascript" src="/js/jquery.ui.widget.min.js"></script>
		<script type="text/javascript" src="/js/jquery.iframe-transport.min.js"></script>
		<script type="text/javascript" src="/js/jquery.fileupload.min.js"></script>
		<script type="text/javascript" src="/js/jquery.jcrop.min.js"></script>
		<script type="text/javascript">
			var mw = 400, mh = 300, iw = 320, ih = 200;
			var jcrop_api;
			function initJcrop() {
				$("#original-img").Jcrop({
					onChange : showPreview,
					onSelect : showPreview,
					aspectRatio : iw / ih,
					minSize : [ iw, ih ],
					setSelect : [ (mw - iw) / 2, (mh - ih) / 2, iw, ih ]
				}, function() {
					jcrop_api = this;
				});
			}

			function showPreview(c) {
				if (parseInt(c.w) > 0) {
					var rx = iw / c.w;
					var ry = ih / c.h;
					var w = $("#original-img").width();
					var h = $("#original-img").height();
					$("#preview-img").css({
						width : Math.round(rx * w) + 'px',
						height : Math.round(ry * h) + 'px',
						marginLeft : '-' + Math.round(rx * c.x) + 'px',
						marginTop : '-' + Math.round(ry * c.y) + 'px'
					});
					$('#x').val(c.x);
					$('#y').val(c.y);
					$('#w').val(iw);
					$('#h').val(ih);
				}
			}

			$(function() {
				$('#progress').hide();
				$("#file-upload").fileupload(
						{
							dataType : 'json',
							url : '/uploading',
							dropZone : $('#original-img'),
							add : function(e, data) {
								$('#progress-bar').css('width', '0%');
								$('#progress').show();
								data.submit();
							},
							progressall : function(e, data) {
								var progress = parseInt(data.loaded
										/ data.total * 100, 10)
										+ '%';
								$('#progress-bar').css('width', progress);
							},

							done : function(e, data) {
								var uploadFile = "/upload/tmp/"
										+ data.result.name
								$("#original-img").attr("src", uploadFile);
								$("#preview-img").attr("src", uploadFile);
								$("#picName").val(data.result.name);
								$("#pic").val(data.result.name);
								$('#progress-bar').css('width', '100%');
								$('#progress').fadeOut();
								initJcrop();
								jcrop_api.setImage(uploadFile);
								initJcrop();
							}
						});

			});
		</script>
	</lift:tail>
</lift:children>